################################################################################
# Bass Model
################################################################################
#' 1. bassModel.fit 
#' 2. bassModel
#' 
#' Example
# report_agg = aggregate(cbind(Nl_minority) ~ Nu + Iteration,
#                        data=report,
#                        function(x) mean(x,na.rm=T))
# bass_param = bassModel.fit(report_agg[ ,"Nl_minority"])
# S_pred     = bassModel(p=bass_param[["p"]],
#                        q=bass_param[["q"]],
#                        m=bass_param[["m"]],
#                        steps=10)$Sales


#################
# bassModel.fit #
#################
bassModel.fit <- function(cumSales)
{
    # fit Bass regression and compute m,p,q
    Sales = rev(-1*round(diff(rev(cumSales))))
    Y = cumsum(Sales) # cumSales
    Y   = c(0,Y[1:(length(Y)-1)]) # we want Y_{t-1} not Y_{t}. Y_{0}=0
    Ysq = Y^2
    out = lm(Sales~Y+Ysq)
    
    a = out$coef[1]
    b = out$coef[2]
    c = out$coef[3]
    
    mplus  = (-b+sqrt(b^2-4*a*c))/(2*c)
    mminus = (-b-sqrt(b^2-4*a*c))/(2*c)
    m = max(mminus,mplus)
    
    p = 1/m
    q = b+p
    return(list(p=p,q=q,m=m))
} # end bassModel.fit


#############
# bassModel #
#############
bassModel <- function(p,q,m,steps=100)
{
    S    = double(steps)
    Y    = double(steps+1)
    Y[1] = 0
    
    for(s in 1:steps)
    {
        S[s]   = p*m + (q-p) * Y[s] - (q/m) * Y[s]^2
        Y[s+1] = Y[s] + S[s]
    }#end for
    
    return(list(Sales=S,cumSales=cumsum(S)))
} #end bassModel

