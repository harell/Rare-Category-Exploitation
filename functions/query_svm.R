#' Active learning with "Query by SVM"
#' 
query_svm <- function(labeled_set,
                      unlabeled_set,
                      num_query=NA)
{
    ##################
    # Initialization #
    ##################
    n = nrow(unlabeled_set)
    p = ncol(unlabeled_set)-1
    
    
    ################
    # Disagreement #
    ################
    #################################
    # Fit model to the training-set #
    #################################
    set.seed(20160323)
    ## e1071 package
    model_e1071 = e1071::svm(label ~ ., data=labeled_set,
                             kernel="radial", cost=1e0,
                             scale=T, probability=TRUE)
    y_hat = predict(model_e1071, unlabeled_set, probability=TRUE)
    y_hat = attr(y_hat, "probabilities")
    predictions = as.vector(y_hat[,"minority"])
    
    
    ################
    # Disagreement #
    ################
    informativeness  = abs(predictions-median(predictions))     # predictions is the informativeness quantity up to a scaling factor
    minority_rank    = rank(1-predictions, ties.method="first") # the closer to 1 the rank is, the better
    #uncertainty_rank = rank(informativeness)                    # the closer to 1 the rank is, the less confident we have 
    
    
    ##################
    # Query and Rank #
    ##################
    #' We apply ranking only on the unlabeled pool
    #' The closer an instance rank is to 0, the less confident we are about its true class label
    query = data.frame(index=1:n,
                       confident=informativeness,
                       rank=rank(informativeness))
    #' head(query,3)
    #       index confident  rank
    # 1     1     0.2924867  168
    # 2     2     0.9444969  544
    # 3     3     0.8582473  495
    
    
    #' Determine the order of the unlabeled observations by informativeness
    #' measure.
    query = query[order(query$rank, decreasing=FALSE),]
    #' head(query,3)
    #       index    confident       rank
    # 349   349      0.0002911843    1
    # 392   392      0.0013148428    2
    # 356   356      0.0019311362    3
    
    
    ################
    # Arrange Data #
    ################
    if(is.na(num_query) | num_query>n) num_query=n
    query = query[1:num_query, ] # subset query 
    
    
    return(as.list(query))
} # end query_random