################################################################################
# Reports Utilities
################################################################################
#' 1. import.reports; Import all the reports from the dest folder
#' 2. SparseMatrix_2_LongDataFrame; convert the estimated probabilities into a 
#'    long data frame
#' 3. AUC_by_curve_integration; calculate the AUC of a curv
#' 


##################
# import.reports #
##################
import.reports <- function(reports_folder="./reports")
{
    # List the (csv) reports in the folder
    reports_list = list.files(pattern="[.]csv$", path=reports_folder, full.names=TRUE)
    
    
    # Phrase the reports names
    reports_metadata = data.frame(DATABASE_NAME=NA)
    for(k in 1:length(reports_list)){
        #' Find the indices of the metadata in the file name.
        #' The metadata is encapsulated between () (i.e. round brackets)
        index_metadata = gregexpr("\\((.*?)\\)", reports_list[k], TRUE)
        #' Check that the number of sub string composing the file name is as 
        #' defined in reports_metadata
        #stopifnot(ncol(reports_metadata)==length(index_metadata[[1]]))
        
        ## Extract the sub string to the metadata data frame
        for(l in 1:ncol(reports_metadata)){
            match_start  = index_metadata[[1]][l]
            match_length = attributes(index_metadata[[1]])$match.length[l]
            reports_metadata[k,l] = substr(reports_list[k],
                                           match_start+1,
                                           match_start+match_length-2)
        } # end extracting sub strings
    } # end extracting list_metadata
    
    
    ## Bind reports and add meta data
    reports = c()
    for(r in 1:length(reports_list)) 
    {
        report = data.table::fread(reports_list[r])
        report = as.data.frame(report)
        report[,"DATABASE_NAME"] = reports_metadata[r,"DATABASE_NAME"]
        reports = rbind(reports, report)
    } # end binding reports with metadata
    
    
    return(reports)
}# import.reports


################################
# SparseMatrix_2_LongDataFrame #
################################
#' @reports_folder RData file destination
#' @Policy the desired policy(ies)
#' @Repetition the desired Repetition(s)
SparseMatrix_2_LongDataFrame <- function(reports_folder="./reports",
                                         Policy=NA,
                                         Repetition=NA)
{
    library(Matrix)
    ##################################
    # Locate and Load the RData file #
    ##################################
    RData_file.path = list.files(pattern="[.]RData$", path=reports_folder, full.names=TRUE)
    load(RData_file.path)
    
    
    #################################
    # Check input arguments for NAs #
    #################################
    if(any(is.na(c(Policy,Repetition)))){
        params = data.frame()
        for(object in ls()){
            if(class(get(object)) == "dgCMatrix")
            {
                object_metadata     = strsplit(object,"\\.")
                params = rbind(params,
                               data.frame(Policy=object_metadata[[1]][1],
                                          Repetition=object_metadata[[1]][2]))
            }# if class
        }# for environment_objects
        if(any(is.na(Policy)))     Policy = as.character(unique(params$Policy))
        if(any(is.na(Repetition))) Repetition = sort(as.numeric(as.character(unique(params$Repetition))))
    }# if is.na
    
    
    ############################################
    # Define the desired sparse matrices names #
    ############################################
    params = expand.grid(Policy=Policy,
                         Repetition=Repetition,
                         stringsAsFactors=FALSE)
    params$Name = paste0(params$Policy,".",params$Repetition)   
    
    
    #########################################################
    # Bind the desired matrices to a long format data frame #
    #########################################################
    RData_long_format = data.frame()
    for(p in 1:nrow(params))
    {
        cat("\n# Loading sparse matrix", p,"/", nrow(params))
        ## Get the desired matrix
        current_matrix = get(params[p,"Name"])
        ## Convert current sparse matrix to a data.frame
        current_df = data.frame(Policy=params[p,"Policy"],
                                Repetition=params[p,"Repetition"],
                                Epoch=summary(current_matrix)$j-1,
                                ID=summary(current_matrix)$i,
                                Est=summary(current_matrix)$x)
        ## Add the true class
        current_df$Class = ground_truth_labels_vector[current_df$ID]
        ## Accumulate results
        RData_long_format = rbind(RData_long_format,current_df)
    }# end for RData_long_format
    
    
    ####################
    # Add dataset name #
    ####################
    index_metadata = gregexpr("\\((.*?)\\)", RData_file.path, TRUE)
    match_start    = index_metadata[[1]][1]
    match_length   = attributes(index_metadata[[1]])$match.length[1]
    DATABASE_NAME  = substr(RData_file.path,
                            match_start+1,
                            match_start+match_length-2)
    RData_long_format = cbind(DATABASE_NAME=DATABASE_NAME,
                              RData_long_format)
    
    
    return(RData_long_format)
}# SparseMatrix_2_LongDataFrame





############################
# AUC_by_curve_integration #
############################
#' @x x coordinate
#' @y y coordinate
#'
AUC_by_curve_integration <- function(x,y)
{
    S = vector("numeric",length(x)-1)
    for(i in 2:length(x)){
        a = x[i-1]
        b = x[i]
        f_a = y[i-1]
        f_b = y[i]
        # Trapezoidal rule
        # https://en.wikipedia.org/wiki/Trapezoidal_rule
        S[i] = ((b-a)/2)*(f_a+f_b)
    }
    return(sum(S) / (diff(range(x))*diff(range(y))))
} #end AUC_by_curve_integration