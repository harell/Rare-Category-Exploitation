################################################################################
# Reports Utilities
################################################################################
#' 1. import.reports; Import all the reports from the dest folder
#' 2. reshape_metadata_2_long_data.frame; Conver metadata file to a long DF
#' 3. AUC_by_curve_integration; calculate the AUC of a curve
#' 


##################
# import.reports #
##################
import.reports <- function(reports_folder="./reports")
{
    # List the (csv) reports in the folder
    reports_list = list.files(pattern="[.]csv$", path=reports_folder, full.names=TRUE)
    
    
    # Phrase the reports names
    reports_metadata = data.frame(DATABASE_NAME=NA)
    for(k in 1:length(reports_list)){
        #' Find the indices of the metadata in the file name.
        #' The metadata is encapsulated between () (i.e. round brackets)
        index_metadata = gregexpr("\\((.*?)\\)", reports_list[k], TRUE)
        #' Check that the number of sub string composing the file name is as 
        #' defined in reports_metadata
        #stopifnot(ncol(reports_metadata)==length(index_metadata[[1]]))
        
        ## Extract the sub string to the metadata data frame
        for(l in 1:ncol(reports_metadata)){
            match_start  = index_metadata[[1]][l]
            match_length = attributes(index_metadata[[1]])$match.length[l]
            reports_metadata[k,l] = substr(reports_list[k],
                                           match_start+1,
                                           match_start+match_length-2)
        } # end extracting sub strings
    } # end extracting list_metadata
    
    
    ## Bind reports and add meta data
    reports = c()
    for(r in 1:length(reports_list)) 
    {
        report = data.table::fread(reports_list[r])
        report = as.data.frame(report)
        report[,"DATABASE_NAME"] = reports_metadata[r,"DATABASE_NAME"]
        reports = rbind(reports, report)
    } # end binding reports with metadata
    
    
    return(reports)
} # import.reports


######################################
# reshape_metadata_2_long_data.frame #
######################################
#' @reports r=1,...,R are the repetitions number
#' @Imb.R
#' @Repetition r=1,...,R are the repetitions number
#'
reshape_metadata_2_long_data.frame <- function(report_metadata, 
                                               Imb.R=NA,
                                               Repetition=1){
    ################
    # Ground Truth #
    ################
    # Extract the ground truth
    GT_vector = report_metadata[1,report_metadata[1,] %in% c(-1,1)]
    GT_vector = ifelse(GT_vector==-1,"majority","minority")
    GT_vector = factor(GT_vector)
    # Remove the ground truth from the probability matrix
    report_metadata = report_metadata[-1,]
    
    
    #########################
    # Change policies names #
    #########################
    names_original = c("max_info-random")
    names_new      = c("random")
    for(i in 1:length(names_original))
    {
        old_name = names_original[i]
        new_name = names_new[i]
        report_metadata[report_metadata$Policy %in% old_name,"Policy"] = new_name
    }# end changing policies names
    
    
    ###############################
    # Convert variables to factor #
    ###############################
    report_metadata$Repetition     = factor(report_metadata$Repetition)
    report_metadata$Iteration      = factor(report_metadata$Iteration)
    report_metadata$DATABASE_NAME  = factor(report_metadata$DATABASE_NAME)
    report_metadata$Strategy       = factor(report_metadata$Strategy)
    report_metadata$QueryMethod    = factor(report_metadata$QueryMethod)
    report_metadata$Policy         = factor(report_metadata$Policy)
    
    
    ###################
    # Subset the data #
    ###################
    if(is.na(Imb.R))
        Imb.R = unique(report_metadata$Imb.R)[1]
    #Repetition   = Repetition
    Iteration     = unique(report_metadata$Iteration)
    DATABASE_NAME = unique(report_metadata$DATABASE_NAME)[1]
    
    
    ##########################
    # Create long data.frame #
    ##########################
    prob_reshape = data.frame()
    for(Policy in unique(report_metadata$Policy)){ 
        ## Subset the data
        index_rows = 
            (report_metadata$Imb.R %in% Imb.R) & 
            (report_metadata$Policy %in% Policy) & 
            (report_metadata$Repetition %in% Repetition) &
            (report_metadata$Iteration %in% Iteration) &
            (report_metadata$DATABASE_NAME %in% DATABASE_NAME)
        index_cols = colnames(report_metadata) %in% paste0("X",1:ncol(report_metadata))
        ## Extract probabilities
        prob_matrix = t(data.matrix(report_metadata[index_rows,index_cols]))
        rownames(prob_matrix) = NULL
        colnames(prob_matrix) = NULL
        ## Create long data frame
        n      = nrow(prob_matrix)
        epochs = ncol(prob_matrix)
        for(epoch in 0:(epochs-1)){
            prob_reshape = rbind(prob_reshape,
                                 data.frame(ID=1:n,
                                            Est=prob_matrix[,epoch+1],
                                            Epoch=epoch,
                                            Class=GT_vector,
                                            Policy=Policy))
        } #end fot epoch
    } #end for QueryMethod
    
    # > head(prob_reshape)
    # ID  Est    Epoch    Class     Policy
    # 1   NA     0        majority  random
    # 2   0.34   0        minority  random
    # 3   NA     0        majority  random
    # 4   0.20   0        majority  random
    # 5   NA     0        minority  random
    # 6   NA     0        majority  random
    return(prob_reshape) 
} # reshape_metadata_2_long_data.frame


############################
# AUC_by_curve_integration #
############################
#' @x x coordinate
#' @y y coordinate
#'
AUC_by_curve_integration <- function(x,y)
{
    S = vector("numeric",length(x)-1)
    for(i in 2:length(x)){
        a = x[i-1]
        b = x[i]
        f_a = y[i-1]
        f_b = y[i]
        # Trapezoidal rule
        # https://en.wikipedia.org/wiki/Trapezoidal_rule
        S[i] = ((b-a)/2)*(f_a+f_b)
    }
    return(sum(S) / (diff(range(x))*diff(range(y))))
} #end AUC_by_curve_integration