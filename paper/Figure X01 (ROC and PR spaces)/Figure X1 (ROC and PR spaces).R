################################################################################
# Figure 1 - ROC and PR spaces
################################################################################
##################
# Initialization #
##################
rm(list = ls()); cat("\014")
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=3)


################
# Load dataset #
################
load_dataset(NA) # display data sets attributes
dataset_name = c("Bank",     # 1
                 "Letter",   # 2
                 "Satimage", # 3
                 "Abalone",  # 4
                 "Adult")[5] # 5
dataset = load_dataset(dataset_name)
p = ncol(dataset)-1
n = nrow(dataset)
n_tr = 500


#####################
# Split the dataset #
#####################
index_lists = split_dataset(dataset[,1:p],dataset[,p+1],
                            train_pct=n_tr/n, 
                            imbalance_ratio=ifelse(dataset_name=="Adult",50,NA))
random_index = index_lists[["index_train"]]
if(dataset_name=="Adult") dataset = dataset[,c(-2,-4,-6,-7,-14)]


############################################
# Train SVM with randomly chosen instances #
############################################
# Fit SVM model to the labeled set
mdl.SVM = e1071::svm(label ~ ., data=dataset[random_index,],
                     type="C-classification",
                     cost=1e0, scale=TRUE, probability=TRUE)
# Fit logistic regression model to the labeled set
mdl.glm = glm(label ~ ., data=dataset[random_index,], 
              family = "binomial")


###################
# Evaluate models #
###################
## SVM: Predict
y_hat = predict(mdl.SVM, dataset[-random_index,], probability=TRUE)
y_hat = attr(y_hat, "probabilities")
predictions = y_hat[,"minority"]
pred = ROCR::prediction(predictions, dataset[-random_index,"label"])
## SVM: ROC space
ROC_SVM  = performance(pred, "tpr", "fpr")
perf_AUC = ROCR::performance(pred,"auc") #Calculate the AUC value
AUC_SVM  = perf_AUC@y.values[[1]]
## SVM: Precision-Recall space
PR_SVM = performance(pred, "prec", "rec")
PREBP_ind = which.min(abs(unlist(PR_SVM@x.values)[-100:-1]-unlist(PR_SVM@y.values)[-100:-1]))+100
PREBP_SVM = unlist(PR_SVM@x.values)[PREBP_ind]

## GLM: Predict
predictions = predict(mdl.glm, dataset[-random_index,], type="response")
pred        = ROCR::prediction(predictions, dataset[-random_index,"label"])
## GLM: ROC space
ROC_GLM  = performance(pred, "tpr", "fpr")
perf_AUC = ROCR::performance(pred,"auc") #Calculate the AUC value
AUC_GLM  = perf_AUC@y.values[[1]]
## GLM: Precision-Recall space
PR_GLM = performance(pred, "prec", "rec")
PREBP_ind = which.min(abs(unlist(PR_GLM@x.values)[-100:-1]-unlist(PR_GLM@y.values)[-100:-1]))+100
PREBP_GLM = unlist(PR_GLM@x.values)[PREBP_ind]


##################
# Visualisations #
##################
par(mar=c(6,4,1,1), mfrow=c(1,2), pty="s", cex=1, lwd=2)
## Recall space
plot(0, 0, type="n", 
     xlim=c(0,1), xlab="Cutoff Points",
     ylim=c(0,1), ylab="Recall",
     xaxs='i', yaxs='i',
     sub="(a) Comparison in Recall space")
lines(unlist(PR_SVM@alpha.values), unlist(PR_SVM@x.values), lty=2^1, col=2^1)
lines(unlist(PR_GLM@alpha.values), unlist(PR_GLM@x.values), lty=2^2, col=2^2)
legend("top",
       c("Algorithm 1","Algorithm 2"),
       lty=2^(1:2), col=2^(1:2), text.col=2^(1:2), bty="n")
## Precision space
plot(0, 0, type="n", 
     xlim=c(0,1), xlab="Cutoff Points",
     ylim=c(0,1), ylab="Precision",
     xaxs='i', yaxs='i',
     sub="(b) Comparison in Precision space")
lines(unlist(PR_SVM@alpha.values), unlist(PR_SVM@y.values), lty=2^1, col=2^1)
lines(unlist(PR_GLM@alpha.values), unlist(PR_GLM@y.values), lty=2^2, col=2^2)
legend("topleft",
       c("Algorithm 1","Algorithm 2"),
       lty=2^(1:2), col=2^(1:2), text.col=2^(1:2), bty="n")
## Export Image
MAIN_TITLE = paste("Recall","and","Precision","spaces")
file_name  = paste0("Figure X01 (",MAIN_TITLE,").png")
file_path  = file.path(getwd(),"paper","Figure X01 (ROC and PR spaces)",file_name)
dev.copy(png,filename=file_path, 
         width=21, height=21/2, units="cm", res=300)
dev.off()
## PR space
plot(0, 0, type="n", 
     xlim=c(0,1), xlab="Recall",
     ylim=c(0,1), ylab="Precision",
     xaxs='i', yaxs='i',
     sub="(c) Comparison in PR space")
lines(unlist(PR_SVM@x.values), unlist(PR_SVM@y.values), lty=2^1, col=2^1)
lines(unlist(PR_GLM@x.values), unlist(PR_GLM@y.values), lty=2^2, col=2^2)
abline(a=0,b=1)
legend("topleft",
       c(paste0("Algorithm 1 (PREBP=",round(PREBP_SVM,2),")"),
         paste0("Algorithm 2 (PREBP=",round(PREBP_GLM,2),")")), 
       lty=2^(1:2), col=2^(1:2), text.col=2^(1:2), bty="n")
points(PREBP_SVM,PREBP_SVM, col=2^1, cex=2, pch=19)
points(PREBP_GLM,PREBP_GLM, col=2^2, cex=2, pch=19)
## ROC space
plot(0, 0, type="n", 
     xlim=c(0,1), xlab="False positive rate",
     ylim=c(0,1), ylab="True positive rate",
     xaxs='i', yaxs='i',
     sub="(d) Comparison in ROC space")
lines(unlist(ROC_SVM@x.values), unlist(ROC_SVM@y.values), lty=2^1, col=2^1)
lines(unlist(ROC_GLM@x.values), unlist(ROC_GLM@y.values), lty=2^2, col=2^2)
par(mfrow=c(1,1))
legend(0.6,0.15,
       c(paste0("Algorithm 1 (AUC=",round(AUC_SVM,2),")"),
         paste0("Algorithm 2 (AUC=",round(AUC_GLM,2),")")), 
       lty=2^(1:2), col=2^(1:2), text.col=2^(1:2), bty="n", cex=1)
## Export Image
MAIN_TITLE = paste("PR","and","ROC","spaces")
file_name  = paste0("Figure X01 (",MAIN_TITLE,").png")
file_path  = file.path(getwd(),"paper","Figure X01 (ROC and PR spaces)",file_name)
dev.copy(png,filename=file_path, 
         width=21, height=21/2, units="cm", res=300)
dev.off()