################################################################################
# Attenberg2013 - Dealing with disjunctive classes (Figure 3)
################################################################################
#'
#' Figure 3 represent the minority class instances, with the value on the left 
#' vertical axis showing their relative position in this sorted list. 
#' The x-axis shows the active learning epoch (here each epoch requests 100 new 
#' instances from the pool). The blue trajectories mostly show examples’ 
#' relative positions changing. 
#' Minority examples drop down to the very bottom (certain minority) either 
#' because they get chosen for labeling, or because labeling some other example 
#' caused the model to “realize” that they are minority examples.
#' 
## Initialization
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=2)


################
# Get the data #
################
reports_folder = file.path(getwd(),"reports","metadata")
report_metadata = import.reports(reports_folder)
# > report_metadata[1:3,1:10]
# Imb.R QueryMethod Repetition Iteration  X1      X2      X3      X4      X5      X6  ...
# GT    GT          GT         GT        -1        1      -1      -1      1       -1
# 9.7   random      1          0          NA      0.34    NA      0.196   NA      NA
# 9.7   random      1          1          NA      0.24    NA      0.097   NA      NA
# ...
n = nrow(report_metadata)
p = ncol(report_metadata)


##################
# Pre-processing #
##################
# Create long data.frame
rep = 5
metadata_long = reshape_metadata_2_long_data.frame(report_metadata,
                                                   Repetition=rep)
# > head(metadata_long)
# ID  Est    Epoch    Class     QueryMethod
# 1   NA     0        majority  random
# 2   0.34   0        minority  random
# 3   NA     0        majority  random
# 4   0.20   0        majority  random
# 5   NA     0        minority  random
# 6   NA     0        majority  random

# Convert probabilities to relative rank
# * rank 1 = min(Pr(y is majority))
# * rank n = max(Pr(y is majority))
rel_position_matrix = metadata_long
for(epoch in unique(metadata_long$Epoch)){
    epoch_index = rel_position_matrix$Epoch %in% epoch
    prob_vec    = rel_position_matrix[epoch_index,"Est"]
    rank_vec    = rank(1-prob_vec,na.last="keep")
    rank_vec    = rank_vec/max(rank_vec,na.rm=T)
    ## Convert certain majorities into NAs
    rel_position_matrix[rel_position_matrix$Class %in% "majority","Est"] = NA
    rel_position_matrix[epoch_index,"Est"] = rank_vec
}#end converting probabilities to relative rank

# Remove NAs
rel_position_matrix = rel_position_matrix[complete.cases(rel_position_matrix),]


#################
# Visualization #
#################
Epochs        = unique(rel_position_matrix$Epoch)
DATABASE_NAME = unique(report_metadata$DATABASE_NAME)
library(ggplot2)
fig3 <- ggplot(aes(x=Epoch, y=I(Est), group=ID, color=QueryMethod), data=rel_position_matrix) +
    # geom_jitter() + 
    geom_path() + geom_point() +
    # X axis
    xlab("Epoch #") +
    scale_x_continuous(breaks = Epochs, limits = range(Epochs)) + 
    # Y axis
    scale_y_continuous(breaks = seq(0,1,0.1), limits = c(0,1)) + 
    ylab("Relative Position") +
    # Plot attributes
    facet_grid(QueryMethod~.) + 
    ggtitle(paste0("Figure 3 [@Attenberg2010]; ", toupper(DATABASE_NAME),
                   " dataset"," (repetition=",rep,")")) + 
    theme_bw() +
    theme(axis.text.x=element_text(angle = -90, hjust = 0))
plot(fig3)
# library(plotly)
# ggplotly(fig3)