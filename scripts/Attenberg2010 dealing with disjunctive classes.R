################################################################################
# Attenberg2013 - Dealing with disjunctive classes (Figure 3)
################################################################################
#'
#' Figure 3 represent the minority class instances, with the value on the left 
#' vertical axis showing their relative position in this sorted list. 
#' The x-axis shows the active learning epoch (here each epoch requests 100 new 
#' instances from the pool). The blue trajectories mostly show examples’ 
#' relative positions changing. 
#' Minority examples drop down to the very bottom (certain minority) either 
#' because they get chosen for labeling, or because labeling some other example 
#' caused the model to “realize” that they are minority examples.
#' 
## Initialization
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=2)


################
# Get the data #
################
reports_folder = file.path(getwd(),"reports","metadata")
report_metadata = import.reports(reports_folder)
n = nrow(report_metadata)
p = ncol(report_metadata)


##################
# Pre-processing #
##################
Imb.R         = setdiff(unique(report_metadata$Imb.R),"GT")[1]
QueryMethod   = c("random","svm")[1]
Repetition    = setdiff(unique(report_metadata$Repetition),"GT")[1]
Iteration     = setdiff(unique(report_metadata$Iteration),"GT")
DATABASE_NAME = setdiff(unique(report_metadata$DATABASE_NAME),"GT")[1]

index_rows = 
    (report_metadata$Imb.R %in% Imb.R) & 
    (report_metadata$QueryMethod %in% QueryMethod) & 
    (report_metadata$Repetition %in% Repetition) &
    (report_metadata$Iteration %in% Iteration) &
    (report_metadata$DATABASE_NAME %in% DATABASE_NAME)
index_cols = colnames(report_metadata) %in% paste0("X",1:p)

prob_matrix = t(data.matrix(report_metadata[index_rows,index_cols]))
rownames(prob_matrix) = NULL
colnames(prob_matrix) = NULL
GT_vector = t(data.matrix(report_metadata[1,index_cols]))
rownames(GT_vector) = NULL
colnames(GT_vector) = NULL


## Convert probabilities to relative rank
## * rank 1 = min(Pr(y is majority))
## * rank n = max(Pr(y is majority))
rel_position_matrix = prob_matrix
rel_position_matrix = apply(1-prob_matrix, 2, function(x) rank(x,na.last="keep"))
rel_position_matrix = apply(rel_position_matrix, 2, function(x) x/max(x,na.rm=T))
## Convert certain majorities into NAs
rel_position_matrix[GT_vector %in% -1,] = NA


#################
# Visualization #
#################
epochs = ncol(rel_position_matrix)
par(mar=c(5,5,4,0.5))
plot(x=0, y=0, type="n",
     xlim=c(0,epochs), ylim=c(0,1),
     xlab="Epoch #", ylab="Relative Position", 
     main=paste0(DATABASE_NAME," dataset with ",toupper(QueryMethod)," as query method"),
     sub="Figure 3 [@Attenberg2010]")

pal = colorRamp(c("red","blue")) ## returns a function

for(epoch in 1:epochs){
    y = rel_position_matrix[,epoch]
    x = rep(epoch-1,length(y))
    points(x,y,col=pal(seq(0,1, len=length(y))))
    #text(x,y,1:length(y))
}