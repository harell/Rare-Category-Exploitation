################################################################################
# Attenberg2013 - Data efficiency
################################################################################


##################
# Initialization #
##################
rm(list = ls()); cat("\014")
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))


################
# Load dataset #
################
dataset_name = c("Letter",       # 1
                 "Satimage",     # 2
                 "Abalone",      # 3
                 "Adult")[4]     # 4
dataset = load_dataset(dataset_name)
p = ncol(dataset)-1
n = nrow(dataset)


##############################
# Control simulation nuances #
##############################
reports = data.frame()
repetitions = 1
iterations = 10
verbose = TRUE
param = expand.grid(
    # Unlabeled instances selection approach
    query_method=c("Random","SVM"), 
    # Additional parameters to CAL
    num_query=100, 
    # Train set ranom seed
    seed_train=2015,
    # Train set percentage
    train_pct=100/n,
    # Tess set ranom seed
    seed_test=20160324,
    # Test set percentage
    test_pct=1/3,
    stringsAsFactors=FALSE)


##############
# Simulation #
##############
for(s in 1:nrow(param)){
    ##########################
    # Repetition Allocations #
    ########################## 
    if(verbose) cat('\n',rep('#',40),
                    '\n','# Starting new simulation',
                    '\n',rep('#',40),
                    sep='')
    report = data.frame()
    
    
    #####################
    # Split the dataset #
    #####################
    index_list = split_dataset(X=dataset[,1:p], y=dataset[,p+1],
                               train_pct=100/n, seed_train=param[s,"seed_train"],
                               test_pct=1/3, seed_test=param[s,"seed_test"])
    
    for(i in 0:iterations){ 
        if(verbose) cat('\n','# Iteration ', i, '/', iterations, sep='')
        #######################################
        # Assign data-points into their group #
        #######################################
        DS_train     = dataset[index_list[["index_train"]],]
        DS_test      = dataset[index_list[["index_test"]],]
        DS_unlabeled = dataset[index_list[["index_unlabeled"]],]
        DS_labeled   = dataset[index_list[["index_labeled"]],]
        
        
        ##########################################
        #  Fit model on the labeled data-points  #
        #                   &                    #
        # Evaluate the model on the training set #
        ##########################################
        if(verbose) cat('\n','# Fitting and Evaluating model', sep='')
        set.seed(20160322)
        criteria_list = fit_and_evaluate_model(train_set=DS_labeled,
                                               test_set=DS_test,
                                               inducer="SVM")
        
        
        #####################
        # Store the results #
        #####################
        new_entery = data.frame(QueryMethod=tolower(param[s,"query_method"]),
                                Iteration=i,
                                N=nrow(DS_labeled),
                                AUC=criteria_list$AUC)
        report = rbind(report,new_entery)
        if(verbose) cat('\n','# AUC=', round(criteria_list$AUC,3), sep='')
        
        
        #####################################
        # Query the next data-points to add #
        #####################################
        if(iterations==i){
            if(verbose) cat('\n','# Done', sep='')
            next
        }
        if(verbose) cat('\n','# Querying the next batch', sep='')
        
        ## Choose instances from the unlabeled pool 
        set.seed(20160322)
        if(tolower(param[s,"query_method"])=='random'){
            query_list = query_random(labeled_set=DS_labeled,
                                      unlabeled_set=DS_unlabeled,
                                      num_query=param[s,"num_query"])
        } else if(tolower(param[s,"query_method"])=='svm'){
            query_list = query_svm(labeled_set=DS_labeled,
                                   unlabeled_set=DS_unlabeled,
                                   num_query=param[s,"num_query"])  
        } # if query method
        
        ## Update index_list
        index_chosen = query_list$index
        index_list[["index_labeled"]] = union(
            index_list[["index_labeled"]],
            index_list[["index_unlabeled"]][index_chosen])
        index_list[["index_unlabeled"]] = setdiff(
            index_list[["index_unlabeled"]],
            index_list[["index_unlabeled"]][index_chosen])
        
        
        if(verbose) cat('\n', '#', sep='')
    } # end iterations
    
    
    reports = rbind(reports,report)
} # end for Simulation


#################
# Visualisation #
#################
plot(0,0,type="n",xlim=range(reports$N), ylim=range(reports$AUC), xlab="N", ylab="AUC")
lines(reports[reports$QueryMethod %in% "random","N"], reports[reports$QueryMethod %in% "random","AUC"], col=1)
lines(reports[reports$QueryMethod %in% "svm","N"],    reports[reports$QueryMethod %in% "svm","AUC"],    col=2)
legend("bottom",c("Random","SVM"), lty=1, col=1:2, bty="n")



































