################################################################################
# Attenberg2013 - Data efficiency
################################################################################
# options(error=recover) # debugging mode


##################
# Initialization #
##################
rm(list = ls()); cat("\014")
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))


################
# Load dataset #
################
dataset_name = c("Letter",       # 1
                 "Satimage",     # 2
                 "Abalone",      # 3
                 "Adult")[4]     # 4
dataset = load_dataset(dataset_name)
p = ncol(dataset)-1
n = nrow(dataset)


##############################
# Control simulation nuances #
##############################
# reports = data.frame()
verbose = TRUE
param = expand.grid(
    # Number of runs (enter series of values, such as 1:10)
    repetitions=1:16,
    # Numer of epochs
    iterations=24,
    # Unlabeled instances selection approach
    query_method=c("Random","SVM")[c(1,2)], 
    # Additional parameters to CAL
    num_query=100, 
    # Train set ranom seed 
    seed_train=2016,
    # Train set percentage (fraction) or number (integer)
    train_pct=100,
    # Tess set ranom seed
    seed_test=20160324,
    # Test set percentage (fraction) or number (integer) 
    test_pct=1/3,
    # Data imbalance ratio
    imbalance_ratio=c(3,10,20,30),
    stringsAsFactors=FALSE)
param$seed_train = param$repetitions + param$seed_train
param$seed_test  = param$repetitions + param$seed_test


##############
# Simulation #
##############
cl <- makeCluster(detectCores(), outfile="")   
registerDoParallel(cl)
reports <- foreach(
    s = 1:nrow(param),
    #.export=c("predict_set","setVariablesNames"),
    #.packages="foreach"
    .combine=rbind,
    .options.multicore=list(preschedule=TRUE),
    .errorhandling='stop') %dopar% {#'remove',#dopar
        
        
        ##########################
        # Repetition Allocations #
        ########################## 
        r = param[s,"repetitions"]
        if(verbose) cat('\n',rep('#',40),
                        '\n','# Starting simulation ',s,'/',nrow(param),
                        '\n',rep('#',40),
                        sep='')
        report = data.frame()
        iterations = param[s,"iterations"]
        
        
        #####################
        # Split the dataset #
        #####################
        index_list = split_dataset(X=dataset[,1:p], y=dataset[,p+1],
                                   train_pct=param[s,"train_pct"], 
                                   seed_train=param[s,"seed_train"],
                                   test_pct=param[s,"test_pct"], 
                                   seed_test=param[s,"seed_test"],
                                   imbalance_ratio=param[s,"imbalance_ratio"])
        
        
        for(i in 0:iterations){ 
            if(verbose) cat('\n','# Iteration ', i, '/', iterations, sep='')
            #######################################
            # Assign data-points into their group #
            #######################################
            DS_train     = dataset[index_list[["index_train"]],]
            DS_test      = dataset[index_list[["index_test"]],]
            DS_unlabeled = dataset[index_list[["index_unlabeled"]],]
            DS_labeled   = dataset[index_list[["index_labeled"]],]
            
            
            ##########################################
            #  Fit model on the labeled data-points  #
            #                   &                    #
            # Evaluate the model on the training set #
            ##########################################
            if(verbose) cat('\n','# Fitting and Evaluating model', sep='')
            set.seed(20160322)
            criteria_list = fit_and_evaluate_model(train_set=DS_labeled,
                                                   test_set=DS_test,
                                                   inducer="SVM")
            
            
            #####################
            # Store the results #
            #####################
            new_entery = data.frame(Imb.R=param[s,"imbalance_ratio"],
                                    QueryMethod=tolower(param[s,"query_method"]),
                                    Repetition=r,
                                    Iteration=i,
                                    N=nrow(DS_labeled),
                                    N_majority=table(DS_labeled$label)[["majority"]],
                                    N_minority=table(DS_labeled$label)[["minority"]],
                                    AUC=criteria_list$AUC,
                                    PRBEP=criteria_list$PRBEP,
                                    LIFT=criteria_list$LIFT)
            report = rbind(report,new_entery)
            if(verbose) cat('\n','# AUC=', round(criteria_list$AUC,3), sep='')
            
            
            #####################################
            # Query the next data-points to add #
            #####################################
            if(iterations==i){
                if(verbose) cat('\n','# Done', sep='')
                next
            }
            if(verbose) cat('\n','# Querying the next batch', sep='')
            
            ## Choose instances from the unlabeled pool 
            set.seed(20160322)
            if(tolower(param[s,"query_method"])=='random'){
                query_list = query_random(labeled_set=DS_labeled,
                                          unlabeled_set=DS_unlabeled,
                                          num_query=param[s,"num_query"])
            } else if(tolower(param[s,"query_method"])=='svm'){
                query_list = query_svm(labeled_set=DS_labeled,
                                       unlabeled_set=DS_unlabeled,
                                       num_query=param[s,"num_query"])  
            } # if query method
            
            ## Update index_list
            index_chosen = query_list$index
            index_list[["index_labeled"]] = union(
                index_list[["index_labeled"]],
                index_list[["index_unlabeled"]][index_chosen])
            index_list[["index_unlabeled"]] = setdiff(
                index_list[["index_unlabeled"]],
                index_list[["index_unlabeled"]][index_chosen])
            
            
            if(verbose) cat('\n', '#', sep='')
        } # end iterations
        
        return(report)
        # reports = rbind(reports,report)
    } # end foreach Simulation
stopCluster(cl) 


#################
# Store results #
#################
Imb.R = paste(round(unique(param[,"imbalance_ratio"]),4), collapse = ",")
Rep.N = length(unique(reports$Repetition))
file_name = paste0('(',toupper(dataset_name),')',
                   '(',"Imb.R.=",Imb.R,')',
                   '(',"Reps=",Rep.N,')',
                   '(',Sys.Date(),')',
                   '.csv')
write.csv(reports, file.path(getwd(),"results",file_name), row.names=F)


#################
# Load results #
#################
ratio_name   = c('3','10','20','30')
report_title = paste0('Adult [Imb.R.:',ratio_name,']')
report_name  = c('(ADULT)(Imb.R.=0.5)(Reps=20)(2016-04-03)',    # ID=1; 1:2
                 '(ADULT)(Imb.R.=0.1111)(Reps=20)(2016-04-03)', # ID=2; 1:9
                 '(ADULT)(Imb.R.=0.0526)(Reps=20)(2016-04-03)', # ID=3; 1:19
                 '(ADULT)(Imb.R.=0.0345)(Reps=20)(2016-04-03)') # ID=4; 1:29
report_ID = 2
reports = read.csv(file.path(getwd(),"results",paste0(report_name[report_ID],".csv")))


##################
# Pro-processing #
##################
colnames(reports)
reports_agg = aggregate(
    cbind(N_majority,N_minority,AUC,PRBEP,LIFT) ~ Imb.R + QueryMethod + Iteration + N,
    reports, function(x) mean(x,trim=0.1))


#################
# Visualisation #
#################
criterion = c("N_minority","AUC","PRBEP","LIFT")[2]
plot(0,0,type="n",
     main=report_title[report_ID],
     xlim=range(reports_agg$N), ylim=range(reports_agg[,criterion]),
     xlab="N", ylab=criterion)
lines(reports_agg[reports_agg$QueryMethod %in% "random","N"],
      reports_agg[reports_agg$QueryMethod %in% "random",criterion],
      col=1, type="o")
lines(reports_agg[reports_agg$QueryMethod %in% "svm","N"],
      reports_agg[reports_agg$QueryMethod %in% "svm",criterion],
      col=2, type="o")
legend("bottom",c("Random","SVM"), lty=1, col=1:2, bty="n")

