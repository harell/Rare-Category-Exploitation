################################################################################
# Bloodgood2009 Stabilizing Predictions 
################################################################################
# options(error=recover) # debugging mode


##################
# Initialization #
##################
rm(list = ls()); cat("\014")
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))


################
# Load dataset #
################
dataset_name = c("Letter",       # 1
                 "Satimage",     # 2
                 "Abalone",      # 3
                 "Adult")[2]     # 4
dataset = load_dataset(dataset_name)
p = ncol(dataset)-1
n = nrow(dataset)


#####################
# Split the dataset #
#####################
index_list = split_dataset(X=dataset[,1:p], y=dataset[,p+1],
                           train_pct=100/n, seed_train=2015,
                           test_pct=1/3, seed_test=2017)


#######################################
# Assign data-points into their group #
#######################################
# DS_train     = dataset[index_list[["index_train"]],]
# DS_test      = dataset[index_list[["index_test"]],]
# DS_unlabeled = dataset[index_list[["index_unlabeled"]],]
# DS_labeled   = dataset[index_list[["index_train"]],]


#################################
# Fit model to the training-set #
#################################
K=10
Q=100
prob_matrix = matrix(NA, ncol=K, nrow=n)
label_matrix = matrix(NA, ncol=K, nrow=n)
for(k in 1:K){
    DS_unlabeled = dataset[index_list[["index_unlabeled"]],]
    DS_labeled   = dataset[index_list[["index_labeled"]],]
    n_u = length(index_list[["index_unlabeled"]])
    n_l = length(index_list[["index_labeled"]])
    cat("\nFitting model",k,"using",n_l,"observations","(",n_u,"left )")
    # Fit model to the labeled data
    return_list = fit_and_evaluate_model(train_set=DS_labeled,
                                         test_set=DS_labeled,
                                         inducer="SVM")
    # Extract the labeled data information 
    prob_labeled = return_list$Test_set_predictions
    
    # Store the estimated probabilities and true labels in matrices
    prob_matrix[prob_labeled$Index,k]  = prob_labeled$Minority_Probability       # \in [0,1]
    label_matrix[prob_labeled$Index,k] = as.numeric(prob_labeled$Ground_Truth)-1 # \in {0,1}
    
    # Labeled set augmentation
    set.seed(20160323+k)
    index_chosen = sample(index_list[["index_unlabeled"]],Q)
    index_list[["index_labeled"]] = union(
        index_list[["index_labeled"]],
        index_chosen)
    index_list[["index_unlabeled"]] = setdiff(
        index_list[["index_unlabeled"]],
        index_chosen)
} # end for


######################
# Find Cohen's kappa #
######################
# library(irr)
# # 1. Fix stop set
# x = label_matrix[,c(1,2)]
# x = x[complete.cases(x),]
# kappa2(x, "unweighted")



