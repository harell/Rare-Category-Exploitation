################################################################################
# Lustiger2016 - Comparing Predictions
################################################################################


##################
# Initialization #
##################
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=2)


################
# Load dataset #
################
load_dataset(NA) # display data sets attributes
dataset_name = c("Letter",           # 1
                 "Satimage",         # 2
                 "Abalone",          # 3
                 "Adult")[+3]        # 4
DS = load_dataset(dataset_name)
p = ncol(DS)-1
n = nrow(DS)


#####################
# Split the dataset #
#####################
index_list = split_dataset(X=DS[,1:p], y=DS[,p+1],
                           train_pct=1e2, 
                           seed_train=2305,
                           test_pct=100, 
                           seed_test=2305,
                           imbalance_ratio=NA)
# N_unlabeled = length(index_list[["index_unlabeled"]])
# N_train     = length(index_list[["index_train"]])
table(DS[index_list[["index_train"]],p+1])
table(DS[index_list[["index_test"]],p+1])


#######################################
# Assign data-points into their group #
#######################################
DS_train     = DS[index_list[["index_train"]],]
DS_test      = DS[index_list[["index_test"]],]
DS_unlabeled = DS[index_list[["index_unlabeled"]],]
DS_labeled   = DS[index_list[["index_labeled"]],]


###############################
# Fit model on the train set  #
#             &               #
#    Predict the test set     #
###############################
# ---------------------------------------------------------------------------- #
# Fit models
# ---------------------------------------------------------------------------- #
## 1. SVM model
set.seed(20160323)
model_svm = e1071::svm(label ~ ., data=DS_train,
                       kernel="radial", cost=1e0,
                       scale=T, probability=TRUE)
## 2. Logistic Regression model
model_lr = glm(label ~ ., data=DS_train, 
               family = "binomial")
# ---------------------------------------------------------------------------- #
# Predict the test-set
# ---------------------------------------------------------------------------- #
## 1. SVM model
est_te = predict(model_svm, DS_test, probability=TRUE)
est_te = attr(est_te, "probabilities")
y1 = as.vector(est_te[,"minority"])
## 2. Logistic Regression model
y2 = predict(model_lr, DS_test, type="response")
## 3. Mixture
y3 = rowMeans(cbind(y1,y2))
# ---------------------------------------------------------------------------- #
# Store predictions
# ---------------------------------------------------------------------------- #
Y = data.frame(Class=DS_test[,p+1],
               SVM=y1,
               LR=y2,
               Mixture=y3)
Y.long = reshape2::melt(Y, id.vars='Class', variable.name="Model")


##################
# Visualisations #
##################
# Box plot
lattice::bwplot(value~Class|Model,
                data=Y.long,
                between=list(y=1),
                main="2 Models Estimated Probabilities: Box Plot")


# Scatter plot matrix
car::scatterplotMatrix(~ SVM + LR + Mixture | Class, data=Y,
                       main="2 Models Estimated Probabilities: Scatter Plot Matrix",
                       smoother=FALSE,
                       by.group=TRUE)






