################################################################################
# Lustiger2016 - Estimating the Remaining Minorities
################################################################################


##################
# Initialization #
##################
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=2)


################
# Load dataset #
################
load_dataset(NA) # display data sets attributes
dataset_name = c("Letter",           # 1
                 "Satimage",         # 2
                 "Abalone",          # 3
                 "Adult")[+1]        # 4
DS = load_dataset(dataset_name)
p = ncol(DS)-1
n = nrow(DS)


#####################
# Split the dataset #
#####################
index_list = split_dataset(X=DS[,1:p], y=DS[,p+1],
                           train_pct=1e2, 
                           seed_train=2305,
                           test_pct=1e3, 
                           seed_test=2305,
                           imbalance_ratio=NA)
table(DS[index_list[["index_train"]],p+1])
table(DS[index_list[["index_test"]],p+1])


#######################################
# Assign data-points into their group #
#######################################
DS_train     = DS[index_list[["index_train"]],]
DS_test      = DS[index_list[["index_test"]],]
DS_unlabeled = DS[index_list[["index_unlabeled"]],]
DS_labeled   = DS[index_list[["index_labeled"]],]


###############################
# Fit model on the train set  #
###############################
## 1. SVM model
set.seed(20160323)
model_svm = e1071::svm(label ~ ., data=DS_train,
                       kernel="radial", cost=1e0,
                       scale=T, probability=TRUE)
## 2. Logistic Regression model
model_glm = glm(label ~ ., data=DS_train, 
                family="binomial")


#########################
# Predict the train set #
#########################
## 1. SVM model
est_te   = predict(model_svm, DS_test, probability=TRUE)
est_te   = attr(est_te, "probabilities")
y.tr_svm = as.vector(est_te[,"minority"])
## 2. Logistic Regression model
y.tr_glm = predict(model_glm, DS_test, type="response")


###########################
# Empirical density polts #
###########################
plot(0, 0, type="n", xlim=c(0,1), ylim=c(0,1), 
     ylab="normalize density", xlab=expression(hat(p)),
     main="Train-set estimated probability density plot")
abline(h=0)
# Train-set estimated probability density
dens.x = density(y.tr_svm,from=0,to=1)[["x"]]
dens.y = density(y.tr_svm,from=0,to=1)[["y"]]
dens.y = dens.y/max(dens.y)
lines(dens.x,dens.y,col=1)
# Marginal densities
tr.minority.ind = DS_test[,"label"] %in% "minority" 

dens.x.majority = density(y.tr_svm[!tr.minority.ind],from=0,to=1)[["x"]]
dens.y.majority = density(y.tr_svm[!tr.minority.ind],from=0,to=1)[["y"]]
dens.y.majority = dens.y.majority/max(dens.y.majority)
lines(dens.x.majority, dens.y.majority, col=3)
points(y.tr_svm[!tr.minority.ind], rep(0,length(y.tr_svm[!tr.minority.ind])), 
       col=3, pch="|")

dens.x.minority = density(y.tr_svm[tr.minority.ind],from=0,to=1)[["x"]]
dens.y.minority = density(y.tr_svm[tr.minority.ind],from=0,to=1)[["y"]]
dens.y.minority = dens.y.minority/max(dens.y.minority)
lines(dens.x.minority, dens.y.minority, col=2)
points(y.tr_svm[tr.minority.ind], rep(0,length(y.tr_svm[tr.minority.ind])), 
       col=2, pch="|")




legend("topright", c(expression(hat(p) (y)),
                     expression(hat(p) (y=="minority")),
                     expression(hat(p) (y=="majority"))), 
       lty=1, text.col=1:3, col=1:3, bty="n")


###############################################
# Fitting Beta distributions to the train-set #
###############################################
library(fitdistrplus)
beta.tr.minority = fitdist(y.tr_svm[tr.minority.ind], "beta")
names(beta.tr.minority$estimate) = NULL
alpha = beta.tr.minority$estimate[1]
beta  = beta.tr.minority$estimate[2]
cat("\nMINORITY:","\nalpha =", alpha, "\nbeta  =", beta, "\nE(x)  =", alpha/(alpha+beta))
alpha/(alpha+beta)*nrow(DS_test)
sum(DS_test[,"label"] %in% "minority")

set.seed(1549)
rv = rbeta(n=1e6,alpha,beta)
x = density(rv,from=0,to=1)[["x"]]
y = density(rv,from=0,to=1)[["y"]]
y = y/(max(y))
lines(x,y,lty=2,col=2)


beta.tr.majority = fitdist(y.tr_svm[!tr.minority.ind], "beta")
names(beta.tr.majority$estimate) = NULL
alpha = beta.tr.majority$estimate[1]
beta  = beta.tr.majority$estimate[2]
cat("\nMAJORITY:", "\nalpha =", alpha, "\nbeta  =", beta, "\nE(x)  =", alpha/(alpha+beta))
alpha/(alpha+beta)*nrow(DS_test)
sum(DS_test[,"label"] %in% "minority")

set.seed(1549)
rv = rbeta(n=1e6,alpha,beta)
x = density(rv,from=0,to=1)[["x"]]
y = density(rv,from=0,to=1)[["y"]]
y = y/(max(y))
lines(x,y,lty=2,col=3)

abline(h=0)



# beta.tr = fitdist(y.tr_svm, "beta")
# names(beta.tr$estimate) = NULL
# alpha = beta.tr$estimate[1]
# beta  = beta.tr$estimate[2]
# cat("\nalpha =", alpha, "\nbeta  =", beta, "\nE(x)  =", alpha/(alpha+beta))
# alpha/(alpha+beta)*nrow(DS_test)
# sum(DS_test[,"label"] %in% "minority")
