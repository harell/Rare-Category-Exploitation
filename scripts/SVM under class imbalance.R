################################################################################
# Attenberg2013 - SVM under class imbalance
################################################################################
# options(error=recover) # debugging mode


##################
# Initialization #
##################
rm(list = ls()); cat("\014")
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=3)


################
# Toy data set #
################
n = 1e3
n_minority = 500
n_majority = n-n_minority
cat("\n Imbalanced ratio =",round(n_majority/n_minority,1))
q = 100 # number of query points
set.seed(1544)
X_majority = MASS::mvrnorm(n=n, mu=c(-2,0), Sigma=diag(1,2))
X_minority = MASS::mvrnorm(n=n, mu=c(+2,0), Sigma=diag(1,2))
X = rbind(X_majority[1:n_majority,],X_minority[1:n_minority,])
y = factor(c(rep("majority",n_majority),rep("minority",n_minority)))
dataset = data.frame(X=X,y=y)
# Plots attributes
dataset$pch = ifelse(dataset$y=="majority","-","+")
dataset$col = ifelse(dataset$y=="majority","springgreen4","red")


############################################
# Train SVM with randomly chosen instances #
############################################
# Select q labeled instances randomly
random_index = sample(1:nrow(X),q)
dataset$type = "unlabeled"
dataset[random_index,"type"] = "labeled"
table(dataset[random_index,"y"])

# Fit SVM model
mdl.SVM = e1071::svm(y ~ ., data=dataset[,1:3], subset=random_index,
                     kernel="linear", cost=1e0,
                     scale=T, probability=TRUE)


##################################
# Reconstructing the hyper-plane #
##################################
SV_info = data.frame()
# Get parameters of hiperplane
w  = t(mdl.SVM$coefs) %*% mdl.SVM$SV
w1 = w[,1]; w2 = w[,2]
b  = mdl.SVM$rho
# Flag the support vectors
dataset[,"SV"]              = "No"
dataset[mdl.SVM$index,"SV"] = "Yes"
dataset$SV                  = factor(dataset$SV)



##################
# Visualisations #
##################
par(mfrow=c(1,2))

# Plot (a) - A toy data set of 400 instances, evenly sampled from two class
# Gaussians.
plot(dataset[,1], dataset[,2], 
     col=dataset$col,pch=dataset$pch, cex=1.5, 
     xlim=c(-5,+5), ylim=c(-3,+3),
     sub="(a)", xlab="", ylab="")

# Plot (b) - A logistic regression model trained with 30 labeled instances
# randomly drawn from the problem domain.
plot(dataset[,1], dataset[,2], 
     col="snow3",pch=dataset$pch, cex=1.5, 
     xlim=c(-5,+5), ylim=c(-3,+3),
     sub="(b)", xlab="", ylab="")
points(x=dataset[random_index,1], 
       y=dataset[random_index,2],
       col=dataset[random_index,"col"],pch=dataset[random_index,"pch"], cex=1.5)

abline(a=-b, b=-w1/w2, col="blue", lwd=2)
       
       
# lines(density(X[,1])$x, density(X[,1])$y-3, col=3, lwd=2)
# lines(density(X[,2])$x, density(X[,2])$y-3, col=2, lwd=2)



