################################################################################
# Analyse Metadata - Probabilistic Plots
################################################################################


##################
# Initialization #
##################
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=2)


################
# Get the data #
################
reports_folder  = file.path(getwd(),"reports","metadata")
report_metadata = import.reports(reports_folder)
# > report_metadata[1:3,1:9]
# Imb.R     Strategy    QueryMethod     Policy              Repetition  Iteration   X1      X2      X3      ...
# GT        GT          GT              GT                  GT          GT          -1      1.00    -1 
# 9.7       max_info    random          max_info-random     1           0           NA      0.34    NA  
# 9.7       max_info    random          max_info-random     1           1           NA      0.24    NA  
# ...


##################
# Pre-processing #
##################
## Change policies names
names_original = c("max_tuv-random","greedy-svm","eps_greedy-svm","max_tuv-svm")
names_new      = c("Random","Greedy","eps-Greedy","Informativeness")
for(i in 1:length(names_original))
{
    old_name = names_original[i]
    new_name = names_new[i]
    report_metadata[report_metadata$Policy %in% old_name,"Policy"] = new_name
}# end changing policies names

## Convert metadata to a nested list
metadata_list = metadata_2_list(report_metadata)


#################
# Visualization #
#################
library(ggplot2)
DATABASE_NAME = unique(report_metadata$DATABASE_NAME)

# Parallel coordinate plot
fig1_long_format = reshape_metadata_2_long_format(metadata_list=metadata_list,
                                                  Policy=NA,
                                                  Repetition=5)
fig1_long_format = subset(fig1_long_format, Class=="minority")
Epochs = unique(fig1_long_format$Epoch)
fig1_title = paste0(DATABASE_NAME,";","Parallel Coordinate Plot")
fig1 <- ggplot(aes(x=Epoch, y=Est, group=ID, color=Policy), data=fig1_long_format) +
    # geom_jitter() + 
    geom_path() + geom_point() +
    # X axis
    scale_x_continuous(breaks = Epochs, limits = range(Epochs)) + 
    xlab("Epoch #") + 
    # Y axis
    scale_y_continuous(breaks = seq(0,1,0.1), limits = c(0,1)) + 
    ylab(expression(hat(Pr)(y==minority~"|"~Y==minority))) +
    # Plot attributes
    ggtitle(fig1_title) +
    theme_bw() +
    theme(axis.text.x=element_text(angle = -90, hjust = 0))
plot(fig1)

# Box plots
fig2_long_format = reshape_metadata_2_long_format(metadata_list=metadata_list,
                                                  Policy=c("Random","Greedy","eps-Greedy","Informativeness"),
                                                  Repetition=5)
fig2_title = paste0(DATABASE_NAME,";","Box Plot")
fig2 <- ggplot(fig2_long_format, aes(x=as.factor(Epoch), y=Est, color=Class)) + 
    geom_boxplot() +
    # X axis
    xlab("Epoch #") +
    # Y axis
    scale_y_continuous(breaks = seq(0,1,0.1), limits = c(0,1)) + 
    ylab(expression(hat(Pr)(y==minority))) +
    # Plot attributes
    ggtitle(fig2_title) +
    theme_bw()+
    theme(axis.text.x=element_text(angle = -90, hjust = 0))+ 
    facet_wrap(~Policy, ncol=2)
plot(fig2)


###############
# Export plot #
###############
dir_path = file.path(getwd(),"plots")
plot_prefix = paste0('(',DATABASE_NAME,')',
                     '(',"Imb.R=",setdiff(unique(report_metadata$Imb.R),"GT"),')',
                     '(',"Chosen Rep=",unique(fig2_long_format$Repetition),')',
                     '(',"Epochs=",max(fig2_long_format$Epoch),')')
# Figure 1
ggsave(filename=file.path(dir_path,paste0(plot_prefix,'(',fig1_title,')',".png")), 
       plot=fig1, width=11.7, height=8.3) # A4 size ^T
# Figure 2
ggsave(filename=file.path(dir_path,paste0(plot_prefix,'(',fig2_title,')',".png")), 
       plot=fig2, width=11.7, height=8.3) # A4 size ^T