################################################################################
# Analyse Metadata - Probabilistic Plots
################################################################################
## Initialization
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=2)


################
# Get the data #
################
reports_folder = file.path(getwd(),"reports","metadata")
report_metadata = import.reports(reports_folder)
# > report_metadata[1:3,1:10]
# Imb.R QueryMethod Repetition Iteration  X1      X2      X3      X4      X5      X6  ...
# GT    GT          GT         GT        -1        1      -1      -1      1       -1
# 9.7   random      1          0          NA      0.34    NA      0.196   NA      NA
# 9.7   random      1          1          NA      0.24    NA      0.097   NA      NA
# ...


##################
# Pre-processing #
##################
# Create long data.frame
rep = 5
metadata_long = reshape_metadata_2_long_data.frame(report_metadata,
                                                   Repetition=rep)
# > head(metadata_long)
# ID  Est    Epoch    Class     QueryMethod
# 1   NA     0        majority  random
# 2   0.34   0        minority  random
# 3   NA     0        majority  random
# 4   0.20   0        majority  random
# 5   NA     0        minority  random
# 6   NA     0        majority  random

# Creating wide format from long format
metadata_wide <- reshape2::dcast(metadata_long, ID + Class + QueryMethod ~ Epoch,
                                 value.var="Est")
# > head(metadata_wide)
# ID    Class       QueryMethod 0       1       2       3       4       ...   
# 1     majority    random      NA      NA      NA      NA      NA      ...     
# 1     majority    svm         NA      NA      NA      NA      NA      ...  
# 2     minority    random      0.34    0.24    0.14    0.21    0.17    ...
# 2     minority    svm         0.34    NA      NA      NA      NA      ...    
# 3     majority    random      NA      NA      NA      NA      NA      ...      
# 3     majority    svm         NA      NA      NA      NA      NA      ...    

metadata_long_minority = subset(metadata_long, Class=="minority")
metadata_long_svm = subset(metadata_long, QueryMethod=="svm")


#################
# Visualization #
#################
library(ggplot2)
DATABASE_NAME = unique(report_metadata$DATABASE_NAME)
Imb.R = setdiff(unique(report_metadata$Imb.R),"GT")
Epochs = unique(metadata_long$Epoch)


# Generate basic parallel coordinate plot
fig1_title = paste0("Parallel Coordinate Plot")
fig1 <- ggplot(aes(x=Epoch, y=Est, group=ID, color=QueryMethod), data=metadata_long_minority) +
    # geom_jitter() + 
    geom_path() + geom_point() +
    # X axis
    scale_x_continuous(breaks = Epochs, limits = range(Epochs)) + 
    xlab("Epoch #") + 
    # Y axis
    scale_y_continuous(breaks = seq(0,1,0.1), limits = c(0,1)) + 
    ylab(expression(hat(Pr)(y==minority~"|"~Y==minority))) +
    # Plot attributes
    ggtitle(fig1_title) +
    theme_bw() +
    theme(axis.text.x=element_text(angle = -90, hjust = 0))
plot(fig1)
# Box plots
fig2_title = paste0("Box Plot")
fig2 <- ggplot(metadata_long_svm, aes(x=as.factor(Epoch), y=Est, color=Class)) + 
    geom_boxplot() +
    # X axis
    xlab("Epoch #") +
    # Y axis
    scale_y_continuous(breaks = seq(0,1,0.1), limits = c(0,1)) + 
    ylab(expression(hat(Pr)(y==minority))) +
    # Plot attributes
    ggtitle(fig2_title) +
    theme_bw()+
    theme(axis.text.x=element_text(angle = -90, hjust = 0))
plot(fig2)


###############
# Export plot #
###############
dir_path = file.path(getwd(),"plots")
plot_prefix = paste0('(',DATABASE_NAME,')',
                     '(',"Imb.R=",setdiff(unique(report_metadata$Imb.R),"GT"),')',
                     '(',"Chosen Rep=",rep,')',
                     '(',"Epochs=",max(metadata_long$Epoch),')')
# Figure 1
ggsave(filename=file.path(dir_path,paste0(plot_prefix,'(',fig1_title,')',".png")), 
       plot=fig1, width=12, height=8)
# Figure 2
ggsave(filename=file.path(dir_path,paste0(plot_prefix,'(',fig2_title,')',".png")), 
       plot=fig2, width=12, height=8)