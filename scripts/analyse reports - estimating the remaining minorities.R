################################################################################
# Analyze Reports - Estimating the Remaining Minorities
################################################################################


##################
# Initialization #
##################
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=3)


################
# Get the data #
################
reports_folder = file.path(getwd(),"reports")
reports = import.reports(reports_folder)
colnames(reports)
DATABASE_NAME = unique(reports$DATABASE_NAME)
Imb.R         = unique(reports$Imb.R)
Epochs        = max(reports$Repetition)


##################
# Pro-processing #
##################
# Change policies names
names_original       = c("max_tuv_random","max_tuv_svm","greedy_svm","eps_greedy_svm")
names_new            = c("Random","Informativeness","Greedy","eps-Greedy")
reports$Policy = plyr::mapvalues(reports$Policy, from=names_original, to=names_new)
# Apply transformations
reports = transform(reports, BetaDistExp=round(Nu*alpha/(alpha+beta)))
# Aggregate the data
reports_agg = aggregate(cbind(BetaDistExp,Nu_minority,Nu_minority.est) ~ Nu + Policy,
                        data=reports,
                        function(x) mean(x,na.rm=T))
# > head(reports_agg)
#   Nu  Policy     BetaDistExp Nu_minority Nu_minority.est
# 1  33 eps-Greedy        24.5        24.4            24.4
# 2 133 eps-Greedy        88.9        86.6            86.6
# 3 233 eps-Greedy       117.4       124.6           124.6
# 4 333 eps-Greedy       128.5       108.8           108.8
# 5 433 eps-Greedy       154.1       109.6           109.6
# 6 533 eps-Greedy       175.5       110.5           110.5

# Convert data frame to long format
reports_long <- reshape2::melt(reports_agg,
                               id.vars=(c("Nu", "Policy")),
                               variable.name = "Method")
# > head(reports_long)
#   Nu  Policy     Method      value
# 1  33 eps-Greedy BetaDistExp  24.5
# 2 133 eps-Greedy BetaDistExp  88.9
# 3 233 eps-Greedy BetaDistExp 117.4
# 4 333 eps-Greedy BetaDistExp 128.5
# 5 433 eps-Greedy BetaDistExp 154.1
# 6 533 eps-Greedy BetaDistExp 175.5


#################
# Visualisation #
#################
names_original      = c("Nu_minority","BetaDistExp","Nu_minority.est")
names_new           = c("Ground Truth","Beta Distribution Expectation","Estimated Probabilities Sum")
reports_long$Method = plyr::mapvalues(reports_long$Method, from=names_original, to=names_new)
library(ggplot2)
xlim = range(reports_long$Nu)

fig1 <- ggplot(reports_long, aes(x=Nu, y=value, color=Method)) +
    geom_line(size=1, alpha=0.8) + geom_point(alpha=0.2) +
    # X axis
    scale_x_reverse(breaks=rev(seq(0,xlim[2],100)), limits=rev(xlim)) + 
    xlab("Number of instances within the unlabeled-set") +
    # Y axis
    ylab("Number of minorities remaining") +
    # Plot attributes
    theme_bw() + facet_wrap(~Policy, ncol=1) + 
    theme(axis.text.x=element_text(angle = -90, hjust = 0))
plot(fig1)


###############
# Export plot #
###############
dir_path = file.path(getwd(),"plots")
plot_prefix = paste0('(',DATABASE_NAME,')',
                     '(',"Imb.R=",Imb.R,')',
                     '(Estimating the Remaining Minorities)',
                     '(',"Xlim=","[",xlim[1],",",xlim[2],"]",')',
                     '.png')
ggsave(filename=file.path(dir_path,plot_prefix), plot=fig1, 
       width=8.3, height=11.7) # A4 size