################################################################################
# Analyze Reports - Estimating the Remaining Minorities
################################################################################


##################
# Initialization #
##################
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=3)
# 1. Choose inducers
Chosen_inducers = c("SVM","GLM","Ensemble")[3]


################
# Get the data #
################
reports_folder = file.path(getwd(),"reports")
reports = import.reports(reports_folder)
colnames(reports)
DATABASE_NAME = unique(reports$DATABASE_NAME)
Imb.R         = unique(reports$Imb.R)
Epochs        = max(reports$Repetition)


##################
# Pro-processing #
##################
# Subset report
reports = subset(reports, Inducer %in% Chosen_inducers)
# Change policies names
reports$Policy = plyr::mapvalues(reports$Policy, from=policies_names_original, to=policies_names_new)
# Apply transformations
reports = transform(reports, BetaDistExp=round(Nu*alpha/(alpha+beta)))
# Aggregate the data
reports_agg = aggregate(cbind(BetaDistExp,Nu_minority,Nu_minority.est) ~ Nu + Policy + Inducer,
                        data=reports,
                        function(x) mean(x,na.rm=T))
# > head(reports_agg)
#    Nu                Policy  Inducer BetaDistExp Nu_minority Nu_minority.est
# 1  84 (Ensemble) eps-Greedy Ensemble       0.125       0.125           0.173
# 2 184 (Ensemble) eps-Greedy Ensemble       0.250       0.250           0.445
# 3 284 (Ensemble) eps-Greedy Ensemble       1.500       0.375           1.490


# Convert data frame to long format
reports_long <- reshape2::melt(reports_agg,
                               id.vars=(c("Nu", "Policy","Inducer")),
                               variable.name = "Method")
# > head(reports_long)
#    Nu                Policy  Inducer      Method value
# 1  84 (Ensemble) eps-Greedy Ensemble BetaDistExp 0.125
# 2 184 (Ensemble) eps-Greedy Ensemble BetaDistExp 0.250
# 3 284 (Ensemble) eps-Greedy Ensemble BetaDistExp 1.500


#################
# Visualisation #
#################
names_original      = c("Nu_minority","BetaDistExp","Nu_minority.est")
names_new           = c("Ground Truth","Beta Distribution Expectation","Estimated Probabilities Sum")
reports_long$Method = plyr::mapvalues(reports_long$Method, from=names_original, to=names_new)
reports_long$Method = relevel(reports_long$Method, "Ground Truth") 
library(ggplot2)
xlim = range(reports_long$Nu)

fig1 <- ggplot(reports_long, aes(x=Nu, y=value, color=Method)) +
    geom_line(size=1, alpha=1) + geom_point(alpha=1) +
    # X axis
    scale_x_reverse(breaks=rev(seq(0,xlim[2],100)), limits=rev(xlim)) + 
    xlab("Number of instances within the unlabeled-set") +
    # Y axis
    ylab("Number of minorities remaining") +
    # Plot attributes
    theme_bw() + facet_wrap(~Policy, ncol=1) + 
    theme(axis.text.x=element_text(angle = -90, hjust = 0))
plot(fig1)


###############
# Export plot #
###############
# Simulation metdata
Inducers = paste0(sort(unique(reports_long$Inducer)),collapse=",")

# Plot metdata
dir_path = file.path(getwd(),"plots")
plot_prefix = paste0('(',DATABASE_NAME,')',
                     '(',"Imb.R=",Imb.R,')',
                     '(Estimating the Remaining Minorities)',
                     '(',"Inducers=",Inducers,')',
                     # '(',"Xlim=","[",xlim[1],",",xlim[2],"]",')',
                     '.png')
ggsave(filename=file.path(dir_path,plot_prefix), plot=fig1, 
       width=11.7, height=8.3) # A4^T size
# width=8.3, height=11.7) # A4 size