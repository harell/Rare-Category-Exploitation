################################################################################
# Analyse Reports - Probabilistic Plots
################################################################################


##################
# Initialization #
##################
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=2)
# 1. Choose repetition
chosen_Repetition = 2
# 2. Choose x limits
Xlimits = c(0,48) # 48 = 4 years
# 3. Choose inducers
Chosen_inducers = c("SVM","GLM","Ensemble")[1]


################
# Get the data #
################
est_prob_long = SparseMatrix_2_LongDataFrame(reports_folder="./reports",
                                             Policy=NA, 
                                             Repetition=chosen_Repetition)


##################
# Pre-processing #
##################
# Change policies names
names_original       = policies_names_original
names_new            = policies_names_new
est_prob_long$Policy = plyr::mapvalues(est_prob_long$Policy, from=names_original, to=names_new)
# Subset the data if it's to long
est_prob_long = subset(est_prob_long, Epoch >= Xlimits[1] & Epoch <= Xlimits[2])


#################
# Visualization #
#################
library(ggplot2)
DATABASE_NAME = as.character(unique(est_prob_long$DATABASE_NAME))
Epochs = unique(est_prob_long$Epoch)

# Parallel coordinate plot
fig1_long_format = subset(est_prob_long,
                              Repetition==chosen_Repetition & 
                              Inducer %in% Chosen_inducers &
                              Class=="minority")
fig1_title = paste0(DATABASE_NAME,"; ","Parallel Coordinate Plot")

fig1 <- ggplot(aes(x=Epoch, y=Est, group=ID, color=Policy), data=fig1_long_format) +
    geom_path() + 
    geom_point() +
    # X axis
    scale_x_continuous(breaks=range(Epochs)[1]:range(Epochs)[2], limits=range(Epochs)) + 
    xlab("Epoch #") + 
    # Y axis
    scale_y_continuous(breaks = seq(0,1,0.1), limits = c(0,1)) + 
    ylab(expression(hat(Pr)(y==minority~"|"~Y==minority))) +
    # Plot attributes
    ggtitle(fig1_title) +
    theme_bw() + facet_wrap(~Policy, ncol=2) +
    theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
    guides(colour=FALSE)
plot(fig1)



# Non stationary conditional distribution plot / box plot
library(animation)
fig2_long_format = subset(est_prob_long, 
                          Repetition==chosen_Repetition &
                              Inducer %in% Chosen_inducers)
saveHTML(
    {
        for(epoch in sort(unique(fig2_long_format$Epoch))){
            cat("\n Crunching epoch",epoch,"/",max(unique(fig2_long_format$Epoch)))
            # Subset the data
            fig2_sub = subset(fig2_long_format, Epoch==epoch)
            # Find the IDs of the observations we are going to purchase
            if(epoch != max(unique(fig2_long_format$Epoch))){ # Not the last epoch
                fig2_sub$flag = FALSE
                Policy.Epoch1.ID = subset(fig2_long_format, Epoch %in% epoch, select=c("Policy","ID"))
                Policy.Epoch2.ID = subset(fig2_long_format, Epoch %in% (epoch+1), select=c("Policy","ID"))
                for(policy in unique(Policy.Epoch1.ID$Policy))
                {
                    ind.epoch1.policy = Policy.Epoch1.ID[,"Policy"] %in% policy
                    ind.epoch2.policy = Policy.Epoch2.ID[,"Policy"] %in% policy
                    ID = setdiff(Policy.Epoch1.ID[ind.epoch1.policy,"ID"], Policy.Epoch2.ID[ind.epoch2.policy,"ID"])
                    fig2_sub[(fig2_sub$ID %in% ID) & ind.epoch1.policy,"flag"] = TRUE
                }# end for policy
            } else # The last epoch
                fig2_sub$flag = TRUE
            
            # Find observations relative rank
            fig2_sub$rel.rank = NA
            for(policy in unique(fig2_sub$Policy)){
                ind = fig2_sub$Policy %in% policy
                fig2_sub[ind,"rel.rank"] = rank(fig2_sub[ind,"Est"])/max(rank(fig2_sub[ind,"Est"]))
            }# end relative rank
            
            ##################################
            # Conditional distributions plot #
            ################################## 
            # fig2 <- ggplot(fig2_sub, aes(x=Est, colour=Class, fill=Class)) +
            # fig2 <- ggplot(fig2_sub, aes(x=rel.rank, colour=Class, fill=Class)) +
            #     geom_density(alpha=0.1) + xlim(0,1) +
            #     geom_rug() +
            #     theme_bw() +
            #     facet_wrap(~Policy, ncol=1, scales="free_y") +
            #     ggtitle(paste0(DATABASE_NAME,"-",
            #                    paste0(unique(fig2_long_format$Inducer),collapse=","),
            #                    "; Epoch ",epoch))
            
            ############
            # Box plot #
            ############
            set.seed(2016)
            fig2 <- ggplot(fig2_sub, aes(x=Class,y=rel.rank)) +
                geom_boxplot() + #geom_boxplot(size=2) +
                geom_jitter(aes(color=flag),alpha=0.5) +
                facet_wrap(~Policy, nrow=1) +
                theme_bw() + guides(color=FALSE) +
                ggtitle(paste0(DATABASE_NAME,"-",
                               paste0(unique(fig2_long_format$Inducer),collapse=","),
                               "; Epoch ",epoch))
            
            
            plot(fig2)
            ani.pause()
        }# adding time dimension
    }, interval=0.5, ani.width=800, ani.height=600)


################
# Export plots #
################
# Simulation metdata
Inducers = paste0(sort(unique(fig1_long_format$Inducer)),collapse=",")

# Plot metdata
dir_path = file.path(getwd(),"plots")
plot_prefix = paste0('(',DATABASE_NAME,')',
                     '(',"Imb.R=",setdiff(unique(est_prob_long$Imb.R),"GT"),')',
                     '(',"Inducers=",Inducers,')',
                     '(',"Chosen Rep=",chosen_Repetition,')',
                     '(',"Epochs=",max(fig2_long_format$Epoch)+1,')')
# Figure 1
ggsave(filename=file.path(dir_path,paste0(plot_prefix,'(',fig1_title,')',".png")), 
       plot=fig1, width=11.7, height=8.3) # A4 size ^T