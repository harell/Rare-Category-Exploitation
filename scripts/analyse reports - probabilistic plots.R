################################################################################
# Analyse Reports - Probabilistic Plots
################################################################################


##################
# Initialization #
##################
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=2)


################
# Get the data #
################
est_prob_long  = SparseMatrix_2_LongDataFrame(reports_folder="./reports",
                                              Policy=NA, 
                                              Repetition=NA)


##################
# Pre-processing #
##################
# Change policies names
names_original       = c("max_tuv_random","max_tuv_svm","greedy_svm","eps_greedy_svm")
names_new            = c("Random","Informativeness","Greedy","eps-Greedy")
est_prob_long$Policy = plyr::mapvalues(est_prob_long$Policy, from=names_original, to=names_new)


#################
# Visualization #
#################
library(ggplot2)
DATABASE_NAME = as.character(unique(est_prob_long$DATABASE_NAME))
Epochs = unique(est_prob_long$Epoch)
chosen_Repetition = 5
#
# Parallel coordinate plot
#
fig1_long_format = subset(est_prob_long, 
                          Policy %in% c("Random","Greedy","eps-Greedy","Informativeness")[-1] &
                              Repetition==chosen_Repetition & 
                              Class=="minority")
fig1_title = paste0(DATABASE_NAME,"(","Repetition ",chosen_Repetition,")","; ","Parallel Coordinate Plot")

fig1 <- ggplot(aes(x=Epoch, y=Est, group=ID, color=Policy), data=fig1_long_format) +
    geom_path() + 
    geom_point() +
    # X axis
    scale_x_continuous(breaks = Epochs, limits = range(Epochs)) + 
    xlab("Epoch #") + 
    # Y axis
    scale_y_continuous(breaks = seq(0,1,0.1), limits = c(0,1)) + 
    ylab(expression(hat(Pr)(y==minority~"|"~Y==minority))) +
    # Plot attributes
    ggtitle(fig1_title) +
    theme_bw() +
    theme(axis.text.x=element_text(angle = -90, hjust = 0))
plot(fig1)
#
# Box plots
#
fig2_long_format = subset(est_prob_long, Repetition==chosen_Repetition)
fig2_title = paste0(DATABASE_NAME,"(","Repetition ",chosen_Repetition,")","; ","Box Plot")

fig2 <- ggplot(fig2_long_format, aes(x=as.factor(Epoch), y=Est, color=Class)) + 
    geom_boxplot() +
    # X axis
    xlab("Epoch #") +
    # Y axis
    scale_y_continuous(breaks = seq(0,1,0.1), limits = c(0,1)) + 
    ylab(expression(hat(Pr)(y==minority))) +
    # Plot attributes
    ggtitle(fig2_title) +
    theme_bw()+
    theme(axis.text.x=element_text(angle = -90, hjust = 0))+ 
    facet_wrap(~Policy, ncol=2)
plot(fig2)
#
# Purchased instances plot
#
fig3_long_format = subset(est_prob_long, Repetition==chosen_Repetition)
fig3_long_format = find_the_purchased_instances(fig3_long_format)
fig3_title = paste0(DATABASE_NAME,"(","Repetition ",chosen_Repetition,")","; ","Purchased Instances Path Plot")

fig3 <- ggplot(fig3_long_format, aes(x=as.factor(Epoch), y=Est, color=Class, shape=Class)) + 
    # geom_point(alpha=0.8) +
    geom_jitter(alpha=0.8) +
    # X axis
    xlab("Epoch #") +
    # Y axis
    scale_y_continuous(breaks = seq(0,1,0.1), limits = c(0,1)) + 
    ylab(expression(hat(Pr)(y==minority))) +
    # Plot attributes
    ggtitle(fig3_title) +
    theme_bw()+
    theme(axis.text.x=element_text(angle = -90, hjust = 0))+ 
    facet_wrap(~Policy, ncol=2)
plot(fig3)


################
# Export plots #
################
dir_path = file.path(getwd(),"plots")
plot_prefix = paste0('(',DATABASE_NAME,')',
                     '(',"Imb.R=",setdiff(unique(est_prob_long$Imb.R),"GT"),')',
                     '(',"Chosen Rep=",unique(fig2_long_format$Repetition),')',
                     '(',"Epochs=",max(fig2_long_format$Epoch)+1,')')
# Figure 1
ggsave(filename=file.path(dir_path,paste0(plot_prefix,'(',fig1_title,')',".png")), 
       plot=fig1, width=11.7, height=8.3) # A4 size ^T
# Figure 2
ggsave(filename=file.path(dir_path,paste0(plot_prefix,'(',fig2_title,')',".png")), 
       plot=fig2, width=11.7, height=8.3) # A4 size ^T
# Figure 3
ggsave(filename=file.path(dir_path,paste0(plot_prefix,'(',fig3_title,')',".png")), 
       plot=fig3, width=11.7, height=8.3) # A4 size ^T