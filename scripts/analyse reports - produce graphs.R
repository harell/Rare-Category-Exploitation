################################################################################
# Analyze Reports - Produce Graphs
################################################################################
## Initialization
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=3)


################
# Get the data #
################
reports_folder = file.path(getwd(),"reports")
reports = import.reports(reports_folder)
reports = dplyr::arrange(reports,Policy,Repetition)
Xlimits = c(0,48) # 48 = 4 years


##################
# Pro-processing #
##################
# Subset the data if it's to long
reports = subset(reports, Iteration >= Xlimits[1] & Iteration <= Xlimits[2])
# SV.R
reports = transform(reports, 
                    SV.R=round(SV_majority/SV_minority,1),
                    SV.R.Inv=round(SV_minority/SV_majority,1),
                    Beta_Expectation=alpha/(alpha+beta))
# Summary Statistics of Data Subsets
reports_agg = aggregate(
    cbind(Nu_minority, Nu_majority, Nl_minority, Nu_minority.est,
          AUC, PRBEP, LIFT,
          SV_total, SV_minority, SV_majority, SV.R, SV.R.Inv,
          Imb.R.Empirical,
          Qt_minority.est, alpha, beta, Beta_Expectation,
          Quantile,
          Q_Intersect) ~ 
        Policy + Iteration + Nl + DATABASE_NAME,
    reports, 
    function(x) mean(x,trim=0.0,na.rm=TRUE))
# SV.diff
reports_agg$SV.diff = 0
for(m in unique(reports_agg$Policy)){
    Policy_indicator = reports_agg$Policy %in% m
    
    reports_agg[Policy_indicator,"SV.diff"] = 
        c(diff(reports_agg[Policy_indicator,"SV_total"]),0)
} # end for SV.diff
# Nl_minority.diff
reports_agg$Nl_minority.diff = 0
for(m in unique(reports_agg$Policy)){
    Policy_indicator = reports_agg$Policy %in% m
    
    reports_agg[Policy_indicator,"Nl_minority.diff"] = 
        c(diff(reports_agg[Policy_indicator,"Nl_minority"]),0)
} # end for Nl_minority.diff
colnames(reports_agg)
reports_agg = dplyr::arrange(reports_agg,Policy,Iteration)



#################
# Visualization #
#################
criteria = c("Nu_majority",      #  1
             "Nu_minority",      #  2
             "Nu_minority.est",  #  3   
             "Nl_minority",      #  4
             "Nl_minority.diff", #  5
             "AUC",              #  6 
             "PRBEP",            #  7
             "LIFT",             #  8
             "Imb.R.Empirical",  #  9
             "SV_total",         # 10
             "SV.diff",          # 11 
             "SV_minority",      # 12     
             "SV_majority",      # 13
             "SV.R",             # 14
             "SV.R.Inv",         # 15
             "Qt_minority.est",  # 16
             "alpha",            # 17
             "beta",             # 18
             "Quantile",         # 19
             "Q_Intersect",      # 20
             "Beta_Expectation"  # 21
# )[c(4,5)]  # Nl_minority + diff
)[c(4,19)]  # Nl_minority + Quantile
# )[c(16,5)] # Qt.est + Qt
# )[c(16,19)]  # Qt.est + Quantile


################
# Render plots #
################
par(mar=c(4,4,1,1), mfrow=c(length(criteria),1))
# Change policies names
names_original = c("max_tuv_random","max_tuv_svm","greedy_svm","eps_greedy_svm")
names_new      = c("Random","Informativeness","Greedy","eps-Greedy")
for(i in 1:length(names_original))
    reports_agg[reports_agg$Policy %in% names_original[i],"Policy"] = names_new[i]
reports_agg = dplyr::arrange(reports_agg,Policy)
# Plot the aggregated data    
for(criterion in criteria)
{
    xlim = c(0,range(subset(reports_agg, select=Nl))[2])
    ylim = c(0,range(reports_agg[reports_agg[,"Nl"] <= xlim[2] ,criterion])[2])
    # ylim = range(reports_agg[reports_agg[,"Nl"] <= xlim[2] ,criterion])
    plot(0, 0, type="n", 
         main=paste(unique(reports_agg$DATABASE_NAME),"dataset"), 
         sub=paste0("Imb.R=",reports[1,"Imb.R"]),
         xlim=xlim, xlab="N", xaxt = "n",
         ylim=ylim, ylab=criterion)
    Policies = unique(reports_agg$Policy)
    for(p in 1:length(Policies)){
        Policy = Policies[p]
        x = reports_agg[reports_agg$Policy %in% Policy,"Nl"]
        y = reports_agg[reports_agg$Policy %in% Policy,criterion]
        ## Plot curve
        lines(x, y, col=p, type="o")
        ## Calculate curve's AUC
        if(criterion=="Nl_minority"){
            curve_AUC = round(AUC_by_curve_integration(x,y),2)
            text(round(0.8*xlim[2]), 0.1*max(ylim)*p, paste0(Policy," AUC: ",curve_AUC), col=p)
        }
    } #end policies plots
    
    axis(1, at=seq(xlim[1],xlim[2],200), las=2)#, labels=letters[1:10])
    # axis(2, at=seq(ylim[1],ylim[2],10),  las=1)#, labels=letters[1:10])
    abline(v=0); abline(h=0)
    # abline(v=1100)
    legend("bottom", Policies, lty=1, col=1:length(Policies), bty="n")
}# end for plot criterion


###############
# Export plot #
###############
dir_path  = file.path(getwd(),"plots")
plot_name = paste0('(',unique(reports$DATABASE_NAME),')',
                   '(',"Imb.R=",unique(reports$Imb.R),')',
                   # '(',"Policies=",unique(reports$Policy),')',
                   '(',"Reps=",length(unique(reports$Repetition)),')',
                   #'(',"Epochs=",max(reports$Iteration),')',
                   '(',paste(criteria, collapse=","),')')
#'(',paste(sort(criteria), collapse=","),')',
dir.create(dir_path, show=FALSE, recursive=TRUE)
# png(file.path(dir_path,paste0(plot_name,'.png')), width=21, height=29.7, units="cm", res=300)
dev.copy(png,filename=file.path(dir_path,paste0(plot_name,'.png')), width=21, height=29.7, units="cm", res=300)
dev.off()