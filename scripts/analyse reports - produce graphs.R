################################################################################
# Analyze Reports - Produce Graphs
################################################################################
## Initialization
cat("\014"); rm(list = ls())
source("scripts/load_libraries.R")
invisible(sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source))
options(digits=2)


################
# Get the data #
################
reports_folder = file.path(getwd(),"reports")
reports = import.reports(reports_folder)
colnames(reports)


##################
# Pro-processing #
##################
# Imb.R.Empirical
# reports = transform(reports, Imb.R.Empirical=round(Nl_majority/Nl_minority,1))
# SV.R
reports = transform(reports, 
                    SV.R=round(SV_majority/SV_minority,1),
                    SV.R.Inv=round(SV_minority/SV_majority,1))
# Summary Statistics of Data Subsets
reports_agg = aggregate(
    cbind(Nu_minority, Nl_minority,
          AUC, PRBEP, LIFT,
          SV_total, SV_minority, SV_majority, SV.R, SV.R.Inv,
          Imb.R.Empirical,
          Expected_Minorities,Real_Minorities) ~ 
        QueryMethod + Iteration + Nl + DATABASE_NAME,
    reports, 
    function(x) mean(x,trim=0.1))#cbind(quantile(x,0.05),mean(x,trim=0.1),quantile(x,0.95)))
# SV.diff
reports_agg$SV.diff = 0
for(m in unique(reports_agg$QueryMethod)){
    QueryMethod_indicator = reports_agg$QueryMethod %in% m
    
    reports_agg[QueryMethod_indicator,"SV.diff"] = 
        c(diff(reports_agg[QueryMethod_indicator,"SV_total"]),0)
} # end for SV.diff
# Nl_minority.diff
reports_agg$Nl_minority.diff = 0
for(m in unique(reports_agg$QueryMethod)){
    QueryMethod_indicator = reports_agg$QueryMethod %in% m
    
    reports_agg[QueryMethod_indicator,"Nl_minority.diff"] = 
        c(diff(reports_agg[QueryMethod_indicator,"Nl_minority"]),0)
} # end for Nl_minority.diff



colnames(reports_agg)


#################
# Visualization #
#################
criteria = c("Nu_minority",             #  1
             "Nl_minority",             #  2
             "Nl_minority.diff",        #  3
             "AUC",                     #  4 
             "PRBEP",                   #  5
             "LIFT",                    #  6
             "Imb.R.Empirical",         #  7
             "SV_total",                #  8
             "SV.diff",                 #  9 
             "SV_minority",             # 10     
             "SV_majority",             # 11
             "SV.R",                    # 12
             "SV.R.Inv",                # 13
             "Expected_Minorities",     # 14
             "Real_Minorities"          # 15
             )[c(3,14,15)]  


par(mfrow=c(length(criteria),1))
for(criterion in criteria)
{
    xlim = c(0,range(subset(reports_agg, select=Nl))[2])
    ylim = c(0,range(reports_agg[,criterion])[2])
    ylim = range(reports_agg[,criterion])
    plot(0, 0, type="n", 
         main=paste(unique(reports_agg$DATABASE_NAME),"dataset"), 
         sub=paste0("Imb.R=",reports[1,"Imb.R"]),
         xlim=xlim, xlab="N", xaxt = "n",
         ylim=ylim, ylab=criterion)
    lines(reports_agg[reports_agg$QueryMethod %in% "random","Nl"], 
          reports_agg[reports_agg$QueryMethod %in% "random",criterion], 
          col=1, type="o")
    lines(reports_agg[reports_agg$QueryMethod %in% "svm","Nl"],    
          reports_agg[reports_agg$QueryMethod %in% "svm",criterion],    
          col=2, type="o")
    
    axis(1, at=seq(xlim[1],xlim[2],200), las=2)#, labels=letters[1:10])
    # axis(2, at=seq(ylim[1],ylim[2],10),  las=1)#, labels=letters[1:10])
    abline(v=0); abline(h=0)
    # abline(v=1100)
    legend("bottom",c("Random","SVM"), lty=1, col=1:2, bty="n")
} # end for plot criterion

