################################################################################
# Unit testing for split_dataset 
################################################################################
require(testthat)
context("Split Dataset")


#####################
# 1. Initialization #
#####################
# source("scripts/load_libraries.R")
#sapply(list.files(pattern="[.]R$", path="./functions/", full.names=TRUE), source)
# source("functions/split_dataset.R")


#################################
# 2. Generate syntactic dataset #
#################################
set.seed(2015)
p = 10
n = 100*p
### Imbalance ratios (#minority/#majority)
Imb.R = 1/100
Imb.R### Generate the design matrix
X <- MASS::mvrnorm(n, mu=rep(0,p), Sigma=diag(rep(1,p)))
### Generate coefficient vector
beta <- round(20*runif(p) - 10,1) # explanatory variables coefficients \in [-10,10]
### Create the dependent variable
y.sd  <- sd(X %*% beta)
noise <- 0*rnorm(n, mean=0, sd=1*y.sd) # Add white noise
### Create the dependent variable
y      <- X %*% beta + noise
labels <- ifelse(y < rep(quantile(y, Imb.R), n), "minority", "majority")
labels <- factor(labels)
### Assamble the variables
dataset <- data.frame(X,y=labels)
colnames(dataset) <- c(paste0("X",1:(ncol(dataset)-1)),"label")  


#########################################################
# test that split_dataset() encompass the whole dataset #
#########################################################
test_that("split_dataset encompass the whole dataset", {
    index_list = split_dataset(dataset[,1:p],dataset[,p+1],
                               1/10, 2015,
                               1/3, 2017)
    
    complete_index = c(index_list[[1]],index_list[[2]],index_list[[3]])
    
    expect_that(index_list, is_a("list"))
    expect_equal(length(complete_index),n)
})


#############################################
# test that split_dataset() is reproducable #
#############################################
test_that("split_dataset is reproducible", {
    index_list_1 = split_dataset(dataset[,1:p],dataset[,p+1],
                                 1/10, 2015,
                                 1/3, 2017)
    index_list_2 = split_dataset(dataset[,1:p],dataset[,p+1],
                                 1/10, 2015,
                                 1/3, 2017)
    index_list_3 = split_dataset(dataset[,1:p],dataset[,p+1],
                                 1/10, 2016,
                                 1/3, 2017)
    # Test query_random()
    expect_that(index_list_1 , is_identical_to(index_list_2))
    expect_that(length(setdiff(index_list_1,index_list_3)), is_more_than(0))
})
